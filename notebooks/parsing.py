from collections import Counter

import pandas as pd
import spacy

nlp = spacy.load("en_core_web_sm")
STOP_WORDS = spacy.lang.en.stop_words.STOP_WORDS

def _remove_stopwords(s):
    return ' '.join([w for w in s.split() if w not in STOP_WORDS])

def extract_concepts(text, remove_stopwords=False):
    # clean text
    clean = ' '.join(text.replace('\n', ' ').split())
    doc = nlp(clean)

    # Entities
    items = []
    for ent in doc.ents:
        items.append([ent.text, ent.label_])
    
    # Noun chunks - proxy for general concepts
    
    ### First step is a merger of noun chunks
    for noun_phrase in list(doc.noun_chunks):
        with doc.retokenize() as retokenizer:
            retokenizer.merge(noun_phrase)
    
    ### Second step grabs merged and single nouns
    for token in doc:
        if token.pos_ in ['NOUN'] and token.is_stop==False:
            items.append([token.lemma_, token.pos_])
    
    ### Create a table for people, places, things, ideas
    items = pd.DataFrame(items, columns=['item', 'spacy_type'])
    items['item'] = items['item'].apply(lambda x: x.lower())
    if remove_stopwords==True:
        items['item'] = items['item'].apply(lambda x: _remove_stopwords(x))
        items = items[items['item'] != ''] # resolves condition where stopword removal leaves a blank (e.g., first is a stop word which can be detected as a noun)

    return items.groupby(['item', 'spacy_type']).size().sort_values(ascending=False)


if __name__ == '__main__':
    text = """
        \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nMITOCW | watch?v=D7APJXFJsbc\n\nThe following content is provided under a Creative Commons license. Your support\n\nwill help MIT OpenCourseWare continue to offer high-quality educational resources\n\nfor free. To make a donation or view additional materials from hundreds of MIT\n\ncourses, visit MIT OpenCourseWare at ocw.mit.edu.\n\nPROFESSOR: Before I continue with the material, I want to show you at least the title of a recent\n\npaper in Nature, because it's related to material we have covered in this course. It's\n\nabout the Kerr effect, the effect that one photon can create a phase shift for another\n\nphoton.\n\nAnd one goal, of course, for quantum computation where things are about single\n\nphotons is to have a single-photon Kerr effect that one photon can change the\n\nphase of the other photon in a strong, noticeable way. So maybe one photon should\n\ncreate a phase shift on the order of pi. And this was reported here in this paper.\n\nOf course, the non-linearity created by nonlinear crystals is much too weak for that.\n\nBut what those authors did is they used microwave photos, had microwave photons\n\ninto cavities. And they were coupled through a sapphire substrate with a Josephson\n\njunction.\n\nSo the non-linearity here is the non-linearity of a Josephson junction, which is\n\nactually realized with a superconducting qubit. I can't explain you many more\n\ndetails, but I just thought it sort of cool to see how the Kerr effect, which we\n\ndiscussed and which we discussed for single-photon, is realized, at least in the\n\nmicrowave domain.\n\nAnd also, just sort of to illustrate that I hope this course enables you to read recent\n\nresearch papers, what those people measured is a [? key ?] representation. This is\n\na coherent state. And then they showed, and this is the subject of the paper, that\n\nthe coherent state which has a well-defined phase, lost its phase through the Kerr\n\nmedium.\n\nAnd you clearly see there is a big phase uncertainty. But then after certain time--\n\n1\n\n\n\nthis is experiment and this is simulation-- there is a re-phasing, and the phase is\n\nback. There is a revival of the coherent state. All right.\n\nNow I want to address one question which Cody asked about the g2 function and\n\nfluctuations of single-mode light. Let me just summarize. I told you that if you do the\n\nthermodynamics of a single mode, we find Bose-Einstein distribution of photons.\n\nAnd we have a thermal distribution. And a thermal distribution means sometimes we\n\nhave more photons, sometimes we have less photons, depending on the thermal\n\ndistribution.\n\nAnd when we calculated what the intensity fluctuations were, we found they're\n\ncharacterized by a g2 function of 2. OK.\n\nThen a little bit later in this course-- actually, just this week-- I told you that single-\n\nmode light always has a g2 function of one. And what I meant here is the following,\n\nrather trivial. If you have a single mode, that means that you [? align ?] [? it ?] is\n\nsimply e to the i omega t, the intensity is constant.\n\nThere are no intensity fluctuations. And also, because everything is sort of\n\npredictable, it's just one wave. The Gn function factorizes into-- can be re-\n\nexpressed by the g1 function. So therefore, this is the most trivial case.\n\nBut the question now is, how do we reconcile those two statements, that a single\n\nmode, e to the i omega t, does not have intensity fluctuations? Therefore, is a g2\n\nfunction of one. And our earlier treatment about single-mode black-body radiation.\n\nAnd of course, the answer is, what is the single mode in one context is different\n\nfrom the single mode in the other context. Maybe let me explain that. Let's just\n\ncreate an ensemble of cavities.\n\nWe put them in thermal contact with a reservoir. And then we break the thermal\n\ncontact with a reservoir. Each cavity has now a perfect single mode, e to the i\n\nomega t. But each cavity is filled with a different photon number according to the\n\nthermal statistics.\n\n2\n\n\n\nSo therefore, if you just look at one cavity, we find no intensity fluctuations. The g2\n\nfunction is one. But if you extend the ensemble average over all the different\n\ncavities, we find that there are fluctuations in intensity.\n\nWell, we can now keep that in mind. But now we can say, well, let's just take one\n\ncavity which is weakly coupled to a thermal reservoir. And instead of looking at the\n\nensemble average of many cavities, we look at the long-time average of this one\n\ncavity. And what will happen is thermal photons will be created, will disappear, and\n\nsuch. So now this one cavity fluctuates.\n\nBut technically, what that means now is it means that the sharp mode of the cavity is\n\ninteracting with the environment, and it becomes broadened. It has a broadening\n\ndelta omega. And this can be regarded as that we mix in modes of the environment.\n\nSo in that case, strictly speaking, it's no longer a single-mode cavity. So you have to\n\nconsider those things. And depending what point of view you want to take, you get\n\nthe different result. Other questions?\n\nThen let me ask you a question. Last class, I explained to you-- well, at least, tried\n\nto explain to you that g2 function for bosons and fermions with the counting\n\nstatistics, with permutations and such. I wasn't sure, at least from one question I\n\ngot, whether this was completely clear. Do you have any question about that? [?\n\nTeroy. ?]\n\nAUDIENCE: This seems very obvious. But during class, I was trying to something with thermal\n\nstate. What is the definition of our thermal state in terms of any basis, just generally\n\nspeaking? We write it as-- I thought it'd be something like e to the minus beta light\n\nHamiltonian.\n\nPROFESSOR: Yeah. So our definition of the thermal state-- when we had thermal light, we say that\n\nthe statistical operator is given by that. And H is the Hamiltonian for a single-mode\n\nlight, which is n plus 1/2 nn. Well, with suitable parentheses and summations. Other\n\nquestions? OK.\n\nThen let's get to the main subject we want to discuss now. And these are actually\n\n3\n\n\n\nFeynman diagrams. I wanted to give you an exact definition and a deep\n\nunderstanding, what does it mean when we talk about processes of absorption and\n\nemission, but also about absorption, emission processes which violate energy.\n\nAnd some people refer to them as virtual photons. The reason is that virtual\n\nphotons cannot really exist for a long time. When you emit a virtual photon, another\n\nphoton has to be absorbed immediately to reconcile energy conservation, as we\n\nwant to see in a moment.\n\nSo the goal of this presentation is I want you that you realize that each of those\n\ndoodles has an exact mathematical meaning. Each of those diagrams represents\n\none term, or a class of terms, in an exact solution for the time evolution of the\n\nsystem.\n\nSo in other words, if you would ask me, we have a ground and excited state. Is it\n\npossible that the ground state emits a photon, goes to a virtual state, emits another\n\nphoton of another frequency, and then somehow absorbs the photon, goes to here,\n\nand eventually takes another photon, and is back to the ground state. Is that a\n\npossibility? Can that happen?\n\nAnd I think what the message here is yes, everything happens. The system is trying\n\nout all of its possibility. And the two time evolution is the sum of all those\n\npossibilities, of all the amplitudes related to those diagrams.\n\nBut what I want to show you is how sort of the weirder the diagrams get, the more\n\nyou go in energy below the ground state, the more you go away from real atomic\n\nstates, the bigger is your energy denominator. And that means those diagrams\n\nhave a smaller and smaller weight. And in all practical calculations, we neglect\n\nthose.\n\nBut I want you sort of to be able to see that and realize, I exactly know what it\n\nmeans. It means this and this term in a summation over all the amplitudes which the\n\nquantum system is exploring.\n\nAnd I think with that, we really learn something about physics. We learn about what\n4\n\n\n\nis actually inside the Schrodinger equation. A lot of people actually, before they take\n\nthis class, think that this is just nonsense, that this has no physical reality. But I hope\n\nafter this class, you see that pretty much everything you draw has physical reality.\n\nIt's just-- it may not contribute a lot.\n\nSo what we have done-- and let me just start here and invite your questions. We\n\nhave figured out how an initial state evolves with a time evolution operator to\n\nanother basis state, toward the final state. And formally, this is the formal solution\n\nand exact solution of the Schrodinger equation.\n\nWe have to sum over all orders, orders in the interaction. Well, I will immediately tell\n\nyou what is the first and second order. We are not going much higher. But if you\n\nwant, here, you can. And then what you have to do is in the time evolution, you\n\nhave to sum over intermediate times. You have to allow the system to propagate, to\n\nchange its state, propagate again, change its state again.\n\nAnd the times where the change of state happens, that can happen at any time\n\nbetween your initial and your final time. And we integrate over all possible times.\n\nAnd I showed you-- and I think this was the very last thing we did on Wednesday. I\n\nshowed you how this diagram can be translated into mathematical equation. And I\n\nthink I picked the second order diagram.\n\nBut I think from the way how I presented should be clear now how any such\n\ndiagram can be translated into an equation. And eventually, you have to perform an\n\nintegral over all intermediate times. And this is part of the time evolution of the\n\nsystem. Questions about that?\n\nAUDIENCE: 
    """
    print(extract_concepts(text, remove_stopwords=True).head(50))
